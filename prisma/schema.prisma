// Prisma schema for Discord Bot persistence
// Using SQLite for lightweight, file-based storage in production.
// Run `npx prisma migrate dev --name init` after editing.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Note: Default DATABASE_URL is SQLite. For Docker, it defaults to file:/data/dev.db.
// For local dev, use file:./prisma/dev.db in your .env. Do not switch Prisma to Postgres unless you plan migrations.


model Persona {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  systemPrompt String
  styleHints   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("personas")
}

model AnalyticsEvent {
  id        Int      @id @default(autoincrement())
  timestamp DateTime @default(now())
  guildId   String?
  userId    String
  command   String
  isSuccess Boolean

  @@map("analytics")
}

model ModerationConfig {
  id               Int      @id @default(autoincrement())
  guildId          String   @unique
  strictnessLevel  String   @default("medium") // "low", "medium", "high"
  enabledFeatures  String   @default("text,image") // JSON array as string
  logChannelId     String?
  autoDeleteUnsafe Boolean  @default(true)
  customKeywords   String?  // JSON array as string
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("moderation_configs")
}

model ModerationIncident {
  id          Int      @id @default(autoincrement())
  guildId     String
  userId      String
  type        String   // "text", "image", "attachment"
  severity    String   // "low", "medium", "high", "critical"
  action      String   // "blocked", "warned", "logged"
  reason      String?
  contentHash String?  // Hash of content for privacy
  metadata    String?  // JSON metadata
  createdAt   DateTime @default(now())

  @@map("moderation_incidents")
}

model UserMemory {
  id         Int      @id @default(autoincrement())
  userId     String   
  guildId    String?  // Optional: guild-specific memories
  memories   String   // JSON object storing key-value memories
  preferences String? // JSON object for user preferences
  summary    String?  // Summarized memory for prompt injection
  lastUpdated DateTime @default(now()) @updatedAt
  memoryCount Int     @default(0) // Track number of stored memories
  tokenCount  Int     @default(0) // Approximate token count for size control
  
  // Memory decay and importance
  lastAccessed DateTime @default(now()) // When memory was last used
  accessCount  Int @default(0) // How often memory has been accessed
  importance   Float @default(0.5) // 0-1 importance score
  decayRate    Float @default(0.05) // How fast memory decays
  
  createdAt   DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  memoryEmbeddings MemoryEmbedding[]

  @@map("user_memories")
  @@unique([userId, guildId])
}

model UserConversationThread {
  id            String   @id @default(cuid())
  userId        String
  guildId       String?
  channelId     String
  threadId      String   // Discord thread ID
  threadTitle   String?  // Title of the thread
  isActive      Boolean  @default(true)
  messageCount  Int      @default(0)
  lastActivity  DateTime @default(now()) @updatedAt
  
  createdAt     DateTime @default(now())
  
  @@map("user_conversation_threads")
  @@unique([userId, guildId, channelId])
  @@index([threadId])
  @@index([isActive, lastActivity])
}

model ConversationMessage {
  id               Int      @id @default(autoincrement())
  channelId        String
  userId           String
  content          String
  role             String   // "user" or "assistant"
  tokens           Int      @default(0) // Token count for this message
  topicTags        String?  // JSON array of detected topics
  importance       Float    @default(0.5) // 0-1 relevance score for context retention
  contextRelevant  Boolean  @default(true) // Whether to include in context windows
  hasAttachments   Boolean  @default(false) // Whether message has image/file attachments
  attachmentData   String?  // JSON metadata about attachments
  
  // Multimodal content flags
  hasImages        Boolean  @default(false)
  hasAudio         Boolean  @default(false)
  hasDocuments     Boolean  @default(false)
  hasCode          Boolean  @default(false)
  mediaFileIds     String?  // JSON array of related MediaFile IDs
  
  createdAt        DateTime @default(now())

  // Relations
  mediaFiles       MediaFile[]

  @@map("conversation_messages")
  @@index([channelId, createdAt])
  @@index([importance, contextRelevant])
  @@index([hasImages, hasAudio, hasDocuments])
}

model ConversationTopic {
  id              Int      @id @default(autoincrement())
  name            String   @unique // Topic name (e.g., "python-programming", "react-hooks")
  displayName     String   // Human-readable name (e.g., "Python Programming", "React Hooks")
  description     String?  // Optional description of the topic
  category        String?  // Topic category (e.g., "programming", "general", "support")
  firstMentioned  DateTime @default(now())
  lastMentioned   DateTime @default(now()) @updatedAt
  frequency       Int      @default(1) // How often this topic appears
  importance      Float    @default(0.5) // 0-1 importance score

  @@map("conversation_topics")
  @@index([category, importance])
  @@index([frequency, lastMentioned])
}


// Media and File Processing Models for Multimodal AI Integration

model MediaFile {
  id              Int       @id @default(autoincrement())
  userId          String
  guildId         String?
  channelId       String
  messageId       String?
  
  // File metadata
  filename        String
  originalName    String
  fileType        String    // image, audio, video, document, code, other
  mimeType        String
  fileSize        Int
  filePath        String    // Storage path or URL
  
  // Processing status
  processingStatus String   @default("pending") // pending, processing, completed, failed
  processedAt     DateTime?
  processingError String?
  
  // Content analysis results
  extractedText   String?   // OCR or document text
  description     String?   // AI-generated description
  tags            String?   // JSON array of auto-generated tags
  categories      String?   // JSON array of content categories
  
  // Metadata and analysis
  imageMetadata   Json?     // Image dimensions, format, EXIF data
  audioMetadata   Json?     // Duration, format, audio properties  
  documentMetadata Json?    // Pages, word count, document properties
  
  // AI analysis results
  visionAnalysis  Json?     // Object detection, OCR, scene analysis
  audioAnalysis   Json?     // Transcription, speaker detection, sentiment
  contentSafety   Json?     // Safety scores, content warnings
  
  // Relationships
  conversationMessages ConversationMessage[]
  mediaInsights   MediaInsight[]
  moderationResults ContentModerationResult[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("media_files")
  @@index([userId, createdAt])
  @@index([fileType, createdAt])
  @@index([processingStatus])
  @@index([channelId, createdAt])
}

model MediaInsight {
  id              Int       @id @default(autoincrement())
  mediaFileId     Int
  
  // Insight type and content
  insightType     String    // object_detection, text_recognition, scene_analysis, audio_transcription, sentiment_analysis
  confidence      Float
  content         Json      // Structured insight data
  
  // Metadata
  generatedBy     String    // Service that generated insight (google_vision, openai_gpt4v, etc.)
  processingTime  Int?      // Time taken to generate insight (ms)
  
  // Relationships
  mediaFile       MediaFile @relation(fields: [mediaFileId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  
  @@map("media_insights")
  @@index([mediaFileId, insightType])
  @@index([insightType, confidence])
}

model MultimodalConversation {
  id              Int       @id @default(autoincrement())
  conversationId  String    // Reference to conversation session
  
  // Multimodal context
  mediaReferences String?   // JSON array of related media files
  visualContext   Json?     // Visual context summary
  audioContext    Json?     // Audio context summary
  documentContext Json?     // Document context summary
  
  // AI processing
  multimodalSummary String? // Summary incorporating all modalities
  keyVisualElements String? // JSON array of important visual elements
  extractedEntities String? // JSON array of named entities from all content
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("multimodal_conversations")
  @@index([conversationId])
}

model ContentModerationResult {
  id              Int       @id @default(autoincrement())
  mediaFileId     Int?
  messageId       String?
  
  // Moderation results
  moderationStatus String   // approved, flagged, rejected, pending_review
  safetyScore     Float?    // Overall safety score (0-1)
  flaggedCategories String? // JSON array of categories that triggered flags
  
  // Detailed analysis
  adultContent    Float?    // Adult content probability
  violenceContent Float?    // Violence content probability
  hateSpeech      Float?    // Hate speech probability
  spamContent     Float?    // Spam probability
  
  // Actions taken
  actionTaken     String?   // none, warning_sent, content_hidden, user_timeout
  reviewRequired  Boolean   @default(false)
  reviewedBy      String?   // Admin who reviewed
  reviewedAt      DateTime?
  
  // Relationships
  mediaFile       MediaFile? @relation(fields: [mediaFileId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime  @default(now())
  
  @@map("content_moderation_results")
  @@index([moderationStatus])
  @@index([safetyScore])
  @@index([reviewRequired])
}

model User {
  id        String   @id // Discord user ID
  username  String?  // Discord username for reference
  optedInAt DateTime? // When user first opted in via /chat
  optedOut  Boolean  @default(false) // If user has opted out
  optedOutAt DateTime? // When user opted out
  
  // Privacy and data management
  privacyAccepted Boolean @default(false) // Explicit privacy policy acceptance
  privacyAcceptedAt DateTime? // When privacy was accepted
  dataRetentionDays Int @default(90) // Custom retention period
  
  // Consent tracking
  consentToStore Boolean @default(false) // Consent to store memories
  consentToAnalyze Boolean @default(false) // Consent to analyze behavior
  consentToPersonalize Boolean @default(false) // Consent to personalization
  
  // Data lifecycle
  lastActivity DateTime @default(now()) @updatedAt
  dataExportedAt DateTime? // Last data export timestamp
  scheduledDeletion DateTime? // When data is scheduled for deletion

  // Conversation routing and controls
  dmPreferred  Boolean  @default(false)
  lastThreadId String?
  pauseUntil   DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memories UserMemory[]
  style    StyleProfile?
  summaries Summary[]
  
  @@map("users")
}

model MemoryEmbedding {
  id          Int      @id @default(autoincrement())
  memoryId    Int
  content     String   // The text content that was embedded
  embedding   Bytes    // Gemini embedding vector stored as bytes
  kind        MemoryKind // Type of memory (FACT, PREF, NOTE)
  weight      Float    @default(0.7) // Importance weight
  lastSeenAt  DateTime @updatedAt
  sourceMsgId String?  // Original message ID
  
  createdAt   DateTime @default(now())
  
  // Relations
  userMemory  UserMemory @relation(fields: [memoryId], references: [id], onDelete: Cascade)
  
  @@map("memory_embeddings")
  @@index([kind, weight])
  @@index([lastSeenAt])
}

enum MemoryKind { 
  FACT 
  PREF 
  NOTE 
  PROJECT
  RELATIONSHIP
  STYLE
}

/// New granular durable Memory store (in addition to existing UserMemory JSON aggregate)
model Memory {
  id           String   @id @default(cuid())
  userId       String
  kind         MemoryKind
  content      String
  importance   Float    @default(0.7) // [0..1]
  recencyScore Float    @default(0)
  sourceMsgId  String?
  guildId      String?
  embedding    Bytes?   // Optional embedding or external vector id bytes
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

model Summary {
  id        String   @id @default(cuid())
  userId    String
  content   String   // compact profile summary
  version   Int      @default(1)
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}

model KBSource {
  id        String   @id @default(cuid())
  guildId   String
  title     String
  url       String?
  fileId    String?
  checksum  String   @unique
  addedBy   String?
  createdAt DateTime @default(now())

  @@index([guildId])
}

model KBChunk {
  id         String   @id @default(cuid())
  sourceId   String
  content    String
  embedding  Bytes?
  section    String?
  createdAt  DateTime @default(now())

  @@index([sourceId])
}

model ModelSelection {
  id         Int      @id @default(autoincrement())
  timestamp  DateTime @default(now())
  provider   String
  model      String
  latencyMs  Int
  success    Boolean
  // Optional context
  userId     String?
  guildId    String?

  @@map("model_selections")
  @@index([timestamp])
}

model MessageLog {
  id         String   @id @default(cuid())
  userId     String?
  guildId    String?
  channelId  String?
  threadId   String?
  msgId      String
  role       String   // user | assistant | system
  content    String
  tokens     Int      @default(0)
  error      String?
  createdAt  DateTime @default(now())
}

model IntentLog {
  id         String   @id @default(cuid())
  userId     String?
  type       String   // PAUSE | RESUME | DELETE | EXPORT | MOVE_DM | MOVE_THREAD | NEW_TOPIC
  payload    Json?
  createdAt  DateTime @default(now())
}

model StyleProfile {
  userId      String   @id
  tone        String?
  formality   String?
  emojis      Boolean? @default(true)
  readingLvl  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model GuildKnowledgeBase {
  id          String   @id @default(cuid())
  guildId     String   
  content     String   // Knowledge content
  source      String   // 'manual', 'document', 'url', 'discord_message'
  sourceId    String?  // Discord message ID, document ID, etc.
  sourceUrl   String?  // Optional URL to source
  tags        String?  // JSON array of tags for categorization
  confidence  Float    @default(0.8) // 0-1 confidence score
  embedding   Bytes?   // Gemini embedding for retrieval
  
  // Access control
  addedBy     String   // User ID who added this
  isPublic    Boolean  @default(true) // Whether all guild members can see
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("guild_knowledge_base")
  @@index([guildId])
  @@index([source])
  @@index([confidence])
  @@index([tags])
}

model EscalationTicket {
  id          String   @id @default(cuid())
  query       String
  userId      String
  channelId   String
  reason      String
  priority    String   // 'low', 'medium', 'high', 'urgent'
  status      String   @default("open") // 'open', 'assigned', 'in_progress', 'resolved', 'closed'
  assignedTo  String?
  context     String?  // JSON string of context
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([priority])
  @@index([userId])
  @@index([channelId])
}

model InteractionLog {
  id              String   @id @default(cuid())
  query           String
  response        String
  userId          String
  channelId       String
  confidence      Float
  knowledgeGrounded Boolean
  shouldEscalate  Boolean
  processingTime  Int      // milliseconds
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([channelId])
  @@index([createdAt])
  @@index([confidence])
}
